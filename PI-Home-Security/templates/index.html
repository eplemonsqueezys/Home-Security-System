<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alarm Dashboard</title>
<style>
:root {
    --primary: #2c3e50;
    --secondary: #34495e;
    --success: #27ae60;
    --danger: #e74c3c;
    --warning: #f39c12;
    --info: #3498db;
    --light: #ecf0f1;
    --dark: #2c3e50;
}

body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: #f4f4f4; 
    margin: 0; 
    padding: 0;
    color: #333;
}

header { 
    background: var(--primary); 
    color: #fff; 
    padding: 1em; 
    text-align: center; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

nav { 
    background: var(--primary); 
    padding: 0.5em; 
    display: flex;
    justify-content: center;
}

header h1 {
    margin: 0;
    font-size: 1.8rem;
}

nav button { 
    background: none; 
    border: none; 
    color: #fff; 
    padding: 0.8em 1.2em; 
    margin: 0 0.2em; 
    cursor: pointer; 
    border-radius: 4px;
    transition: all 0.3s ease;
    font-weight: 500;
}

nav button:hover, nav button.active { 
    background: var(--secondary); 
}

.content { 
    padding: 1.5em; 
    max-width: 1200px; 
    margin: auto; 
}

.card {
    background: #fff;
    border-radius: 8px;
    padding: 1.5em;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 1.5em;
}

.card-title {
    margin-top: 0;
    color: var(--primary);
    border-bottom: 2px solid var(--light);
    padding-bottom: 0.5em;
    margin-bottom: 1em;
}

.zones { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
    gap: 1.5em; 
}

.zone { 
    background: #fff; 
    padding: 1.2em; 
    border-radius: 8px; 
    text-align: center; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.zone:before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
}

.ok:before { background: var(--success); }
.tripped:before { background: var(--danger); }
.disarmed:before { background: var(--warning); }

.zone h3 {
    margin: 0 0 0.5em;
    font-size: 1.1rem;
}

.zone-status {
    font-size: 1.2rem;
    font-weight: bold;
    margin: 0.5em 0;
}

.ok .zone-status { color: var(--success); }
.tripped .zone-status { color: var(--danger); }

.arm-btn { 
    padding: 0.6em 1em; 
    border: none; 
    color: #fff; 
    cursor: pointer; 
    border-radius: 4px; 
    font-weight: 500;
    width: 100%;
    transition: opacity 0.3s;
}

.arm-btn.save { background: var(--success); }
.arm-btn.disarm { background: var(--danger); }

.arm-btn:hover {
    opacity: 0.9;
}

.global-control {
    display: flex;
    justify-content: center;
    margin-bottom: 2em;
}

#gbtn {
    padding: 0.8em 2em;
    font-size: 1.1rem;
    border-radius: 30px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}

textarea, select, input {
    width: 100%;
    padding: 0.8em;
    margin-bottom: 1em;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: inherit;
}

button {
    background: var(--info);
    color: white;
    border: none;
    padding: 0.8em 1.5em;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.3s;
}

button:hover {
    background: #2980b9;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin: 1em 0;
}

th, td {
    border: 1px solid #ddd;
    padding: 0.8em;
    text-align: left;
}

th {
    background: var(--light);
}

tr:nth-child(even) {
    background: #f9f9f9;
}

.mode-selector {
    display: flex;
    gap: 1em;
    margin-bottom: 1.5em;
}

.mode-option {
    flex: 1;
    text-align: center;
    padding: 1em;
    border-radius: 8px;
    background: var(--light);
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.mode-option.active {
    border-color: var(--info);
    background: #e1f0fa;
}

.mode-option h3 {
    margin-top: 0;
}

.zone-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1em;
    margin: 1em 0;
}

.zone-item {
    display: flex;
    align-items: center;
    gap: 0.5em;
}

.system-info {
    background: var(--light);
    padding: 1em;
    border-radius: 8px;
    margin-top: 2em;
    font-size: 0.9rem;
}

.system-info p {
    margin: 0.3em 0;
}

.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 0.5em;
}

.status-armed { background: var(--danger); }
.status-disarmed { background: var(--success); }

.audio-controls {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 1000;
    display: flex;
    gap: 10px;
}

.audio-btn {
    padding: 8px 12px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
}

.audio-btn.mute {
    background: #dc3545;
}

#loadingIndicator {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    color: white;
    text-align: center;
    padding-top: 20%;
}

.user-controls {
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-info {
    font-size: 0.9rem;
}

/* Table styles for mode zones */
.mode-zones-table {
    width: 100%;
    margin: 1em 0;
    border-collapse: collapse;
}

.mode-zones-table th {
    background-color: var(--light);
    padding: 10px;
    text-align: left;
}

.mode-zones-table td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
}

.mode-zones-table tr:last-child td {
    border-bottom: none;
}

.mode-zones-table input[type="checkbox"] {
    margin-right: 10px;
}

.mode-zones-table label {
    display: flex;
    align-items: center;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fff;
    margin: 15% auto;
    padding: 20px;
    border-radius: 5px;
    width: 300px;
    position: relative;
}

.close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

form label {
    display: block;
    margin-top: 10px;
}

form input {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 10px;
    box-sizing: border-box;
}

form button {
    width: 100%;
    padding: 10px;
    background-color: var(--info);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 10px;
}

.error {
    color: var(--danger);
    margin-top: 10px;
    text-align: center;
}

/* User form styles */
#userDataForm label {
    display: block;
    margin-top: 10px;
}

#userDataForm input {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 10px;
}

#userDataForm button {
    margin-top: 10px;
    margin-right: 10px;
    display: inline-block;
    width: auto;
}
</style>
</head>
<body>

<div id="loadingIndicator">
    <h2>Processing Changes...</h2>
</div>

<header>
    <h1>Alarm Dashboard</h1>
    <div class="user-controls">
        <div class="user-info">
            <span id="usernameDisplay">Not logged in</span>
            <span id="userRole"></span>
        </div>
        <button id="logoutBtn" style="display:none;">Logout</button>
        <button id="loginBtn">Login</button>
    </div>
</header>
<nav>
    <button onclick="show('status')" class="active">Status</button>
    <button onclick="show('options')">Options</button>
    <button onclick="show('modes')">Home/Away Mode</button>
    <button onclick="show('schedules')">Schedules</button>
    <button onclick="show('pinlayout')">Pin Layout</button>
    <button onclick="show('users')" id="usersTab" style="display:none;">User Management</button>
</nav>

<div class="content">
    <div id="status">
        <div class="global-control">
            <button id="gbtn" class="arm-btn">Loading...</button>
        </div>
        <div class="zones" id="zones"></div>

        <div class="system-info">
            <p><span class="status-indicator" id="armedIndicator"></span> System Status: <span id="systemStatusText">Loading...</span></p>
            <p>Mode: <span id="modeDisplay">Loading...</span></p>
            <p>Last Updated: <span id="lastUpdated">Never</span></p>
        </div>
    </div>

    <div id="options" style="display:none;">
        <div class="card">
            <h3 class="card-title">Zone Labels</h3>
            <textarea id="lab" rows="6" placeholder="Enter one label per line"></textarea>
            <button onclick="saveLabels()">Save Labels</button>
        </div>

        <div class="card">
            <h3 class="card-title">Ding on Unarmed Trip</h3>
            <p>Select zones that should play a "ding" sound when tripped, even if the system is unarmed.</p>
            <div id="ding-zones-list" class="zone-list"></div>
            <button onclick="saveDingZones()">Save Ding Zones</button>
        </div>
    </div>

    <div id="modes" style="display:none;">
        <div class="card">
            <h3 class="card-title">Current Mode</h3>
            <div class="mode-selector">
                <div class="mode-option" onclick="setMode('home')" id="homeModeOption">
                    <h3>Home Mode</h3>
                    <p>Only perimeter zones armed</p>
                </div>
                <div class="mode-option" onclick="setMode('away')" id="awayModeOption">
                    <h3>Away Mode</h3>
                    <p>All zones armed</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 class="card-title">Mode Zone Configuration</h3>
            <p>Select which zones should be armed in each mode:</p>
            <div class="mode-zones-container">
                <table class="mode-zones-table">
                    <thead>
                        <tr>
                            <th>Zone</th>
                            <th>Home Mode</th>
                            <th>Away Mode</th>
                        </tr>
                    </thead>
                    <tbody id="mode-zones-table"></tbody>
                </table>
            </div>
            <button onclick="saveHomeAwayZones()" style="margin-top: 1em;">Save Mode Configurations</button>
        </div>
    </div>

    <div id="schedules" style="display:none;">
        <div class="card">
            <h3 class="card-title">Current Schedules</h3>
            <table>
                <thead>
                    <tr>
                        <th>Action</th>
                        <th>Time</th>
                        <th>Repeat</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="sched"></tbody>
            </table>
        </div>

        <div class="card">
            <h3 class="card-title">Add New Schedule</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em;">
                <div>
                    <label for="sact">Action:</label>
                    <select id="sact">
                        <option value="arm">Arm System</option>
                        <option value="disarm">Disarm System</option>
                    </select>
                </div>
                <div>
                    <label for="stime">Time:</label>
                    <input type="time" id="stime"/>
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <label><input type="checkbox" id="srep"/> Repeat Daily</label>
                </div>
            </div>
            <button onclick="addSched()" style="margin-top: 1em;">Add Schedule</button>
        </div>
    </div>

    <div id="pinlayout" style="display:none;">
        <div class="card">
            <h3 class="card-title">Zone to GPIO Pin Assignment</h3>
            <p>Assign a Broadcom (BCM) GPIO pin number to each zone. Enter '0' or leave blank if a zone is unused.</p>
            <table>
                <thead>
                    <tr>
                        <th>Zone</th>
                        <th>Label</th>
                        <th>GPIO Pin</th>
                    </tr>
                </thead>
                <tbody id="plist"></tbody>
            </table>
            <button onclick="savePinLayout()" style="margin-top: 1em;">Save Pin Layout</button>
        </div>
    </div>

    <div id="users" style="display:none;">
        <div class="card">
            <h3 class="card-title">User Management</h3>
            <button onclick="showCreateUserForm()">Create New User</button>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Admin</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTable"></tbody>
            </table>
        </div>

        <!-- Create/Edit User Form -->
        <div id="userForm" style="display:none;">
            <div class="card">
                <h3 class="card-title" id="userFormTitle">Create User</h3>
                <form id="userDataForm">
                    <input type="hidden" id="userId">
                    <label for="editUsername">Username:</label>
                    <input type="text" id="editUsername" required>
                    
                    <label for="editPassword">Password:</label>
                    <input type="password" id="editPassword">
                    <small>(Leave blank to keep current password)</small>
                    
                    <label>
                        <input type="checkbox" id="editIsAdmin">
                        Administrator
                    </label>
                    
                    <button type="submit">Save</button>
                    <button type="button" onclick="hideUserForm()">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="audio-controls">
    <button id="testAlarmBtn" class="audio-btn">Test Alarm</button>
    <button id="testDingBtn" class="audio-btn">Test Doorbell</button>
    <button id="muteBtn" class="audio-btn">Mute Sounds</button>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Login</h2>
        <form id="loginForm">
            <label for="username">Username:</label>
            <input type="text" id="username" name="username" required>
            
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>
            
            <button type="submit">Login</button>
            <div id="loginError" class="error"></div>
        </form>
    </div>
</div>

<script>
    let armed, zones, zoneArmed, zoneLabels, pinLayout;
    let schedules = [];  // Initialize as empty array
    let mode, homeModeZones = [], awayModeZones = [], zoneDingUnarmed = [];
    let audioEnabled = true;
    let lastUpdateTime = new Date();
    let pollInterval;
    let isProcessing = false;
    let isPinInputFocused = false;
    let isModeInputFocused = false;
    let currentUser = null;
    
    // Create audio elements
    const alarmAudio = new Audio('/static/alarm.mp3');
    const dingAudio = new Audio('/static/ding.mp3');
    alarmAudio.loop = true;
    
    // DOM elements
    const gbtn = document.getElementById('gbtn');
    const zonesEl = document.getElementById('zones');
    const armedIndicator = document.getElementById('armedIndicator');
    const systemStatusText = document.getElementById('systemStatusText');
    const modeDisplay = document.getElementById('modeDisplay');
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const muteBtn = document.getElementById('muteBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const loginModal = document.getElementById('loginModal');
    const closeBtn = document.querySelector('.close');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const usernameDisplay = document.getElementById('usernameDisplay');
    const userRole = document.getElementById('userRole');
    const usersTab = document.getElementById('usersTab');
    
    // Test buttons
    document.getElementById('testAlarmBtn').addEventListener('click', () => {
        if (audioEnabled) {
            alarmAudio.play().catch(e => console.error("Alarm test error:", e));
            setTimeout(() => alarmAudio.pause(), 2000);
        }
    });
    
    document.getElementById('testDingBtn').addEventListener('click', () => {
        if (audioEnabled) {
            dingAudio.play().catch(e => console.error("Ding test error:", e));
        }
    });
    
    // Mute button
    muteBtn.addEventListener('click', () => {
        audioEnabled = !audioEnabled;
        muteBtn.textContent = audioEnabled ? 'Mute Sounds' : 'Unmute Sounds';
        muteBtn.classList.toggle('mute', !audioEnabled);
    
        if (!audioEnabled) {
            alarmAudio.pause();
            dingAudio.pause();
        }
    });
    
    // Login modal
    loginBtn.addEventListener('click', () => {
        loginModal.style.display = 'block';
    });
    
    closeBtn.addEventListener('click', () => {
        loginModal.style.display = 'none';
    });
    
    window.addEventListener('click', (event) => {
        if (event.target === loginModal) {
            loginModal.style.display = 'none';
        }
    });
    
    function showLoading() {
        loadingIndicator.style.display = 'block';
        isProcessing = true;
    }
    
    function hideLoading() {
        loadingIndicator.style.display = 'none';
        isProcessing = false;
    }
    
    async function fetchAll() {
        if (isProcessing) return;
        
        try {
            const response = await fetch('/api/zone_status');
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error('Network response was not ok');
            }
    
            const js = await response.json();
            armed = js.armed;
            zones = js.zones;
            zoneArmed = js.zone_armed;
            zoneLabels = js.zone_labels;
            pinLayout = js.pin_layout;
            schedules = js.schedules || []; // Ensure it's always an array
            mode = js.mode;
            homeModeZones = js.home_mode_zones;
            awayModeZones = js.away_mode_zones;
            zoneDingUnarmed = js.zone_ding_unarmed;
            
            // Update current user info
            if (js.current_user) {
                currentUser = {
                    username: js.current_user.username,
                    is_admin: js.current_user.is_admin
                };
                updateUIWithUserInfo();
            }

            // Update last updated time
            lastUpdateTime = new Date();
            lastUpdatedEl.textContent = lastUpdateTime.toLocaleTimeString();
    
            render();
            renderOptions();
            renderModes();
            renderSchedules();
            
            // Only refresh pin inputs if not currently focused
            if (!isPinInputFocused) {
                fillPins();
            }
    
            // Check for alarm/ding flags
            await checkFlags();
    
        } catch (e) {
            console.error("Error fetching data:", e);
        }
    }
    
    async function checkFlags() {
        try {
            // Check alarm flag
            const alarmRes = await fetch('/static/alarm.flag');
            const alarmFlag = (await alarmRes.text()).trim() === '1';
    
            // Check ding flag
            const dingRes = await fetch('/static/ding.flag');
            const dingFlag = (await dingRes.text()).trim() === '1';
    
            if (audioEnabled) {
                // Handle alarm sound - only play if system is armed and alarm flag is set
                if (alarmFlag && armed) {
                    try {
                        await alarmAudio.play();
                    } catch(e) {
                        console.error("Alarm play error:", e);
                        // Try again after a short delay
                        setTimeout(() => alarmAudio.play().catch(e => console.error("Retry alarm play error:", e)), 1000);
                    }
                } else {
                    alarmAudio.pause();
                    alarmAudio.currentTime = 0;
                }
    
                // Handle doorbell sound
                if (dingFlag) {
                    dingAudio.play().catch(e => console.error("Ding play error:", e));
                    // Clear ding flag after playing
                    setTimeout(() => fetch('/api/clear_ding'), 1000);
                }
            } else {
                // Ensure sounds are stopped if audio is muted
                alarmAudio.pause();
                dingAudio.pause();
            }
    
        } catch (e) {
            console.error("Error checking flags:", e);
        }
    }
    
    function show(id){
        document.querySelectorAll('nav button').forEach(button => {
            button.classList.remove('active');
        });
        const activeButton = document.querySelector(`nav button[onclick="show('${id}')"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }
    
        ['status','options','modes','schedules','pinlayout','users']
            .forEach(tab => document.getElementById(tab).style.display = (tab === id ? 'block' : 'none'));
            
        if (id === 'users') {
            renderUsers();
        }
    }
    
    function updateUIWithUserInfo() {
        if (currentUser) {
            usernameDisplay.textContent = currentUser.username;
            userRole.textContent = currentUser.is_admin ? '(Admin)' : '(User)';
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            usersTab.style.display = currentUser.is_admin ? 'block' : 'none';
        } else {
            usernameDisplay.textContent = 'Not logged in';
            userRole.textContent = '';
            loginBtn.style.display = 'inline-block';
            logoutBtn.style.display = 'none';
            usersTab.style.display = 'none';
        }
    }
    
    function render(){
        // Update global armed button
        gbtn.textContent = armed ? 'DISARM SYSTEM' : 'ARM SYSTEM';
        gbtn.className = armed ? 'arm-btn disarm' : 'arm-btn save';
        
        // Update status indicator
        armedIndicator.className = armed ? 'status-indicator status-armed' : 'status-indicator status-disarmed';
        systemStatusText.textContent = armed ? 'ARMED' : 'DISARMED';
        systemStatusText.style.color = armed ? '#e74c3c' : '#27ae60'; 
        modeDisplay.textContent = mode === 'home' ? 'Home' : 'Away';
        modeDisplay.style.fontWeight = 'bold';
        systemStatusText.textContent = armed ? 'System Armed' : 'System Disarmed';
    
        // Render zones
        zonesEl.innerHTML = '';
        zones.forEach((tripped, i) => {
            const zoneEl = document.createElement('div');
            zoneEl.className = 'zone ' + 
                (zoneArmed[i] ? (tripped ? 'tripped' : 'ok') : 'disarmed');
    
            zoneEl.innerHTML = `
                <h3>${zoneLabels[i]}</h3>
                <div class="zone-status">${tripped ? 'TRIPPED' : 'SECURE'}</div>
                <button class="arm-btn ${zoneArmed[i] ? 'disarm' : 'save'}">
                    ${zoneArmed[i] ? 'Disarm Zone' : 'Arm Zone'}
                </button>
            `;
    
            zoneEl.querySelector('button').addEventListener('click', () => toggleZone(i));
            zonesEl.appendChild(zoneEl);
        });
    }
    
    function renderOptions(){
        const labelTextarea = document.getElementById('lab');
        if (document.activeElement !== labelTextarea) {
            labelTextarea.value = zoneLabels.join('\n');
        }
    
        const dingListEl = document.getElementById('ding-zones-list');
        dingListEl.innerHTML = '';
    
        zoneLabels.forEach((label, i) => {
            const zoneItem = document.createElement('div');
            zoneItem.className = 'zone-item';
            zoneItem.innerHTML = `
                <input type="checkbox" id="ding-zone-${i}" 
                    ${zoneDingUnarmed.includes(i) ? 'checked' : ''}
                    value="${i}">
                <label for="ding-zone-${i}">${label}</label>
            `;
            dingListEl.appendChild(zoneItem);
        });
    }
    
    function renderModes(){
        // Update mode options
        document.getElementById('homeModeOption').classList.toggle('active', mode === 'home');
        document.getElementById('awayModeOption').classList.toggle('active', mode === 'away');
    
        // Render mode zones table
        const tableBody = document.getElementById('mode-zones-table');
        tableBody.innerHTML = '';
    
        zoneLabels.forEach((label, i) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${label}</td>
                <td>
                    <label>
                        <input type="checkbox" id="home-zone-${i}" 
                            ${homeModeZones.includes(i) ? 'checked' : ''}
                            value="${i}">
                        Enable
                    </label>
                </td>
                <td>
                    <label>
                        <input type="checkbox" id="away-zone-${i}" 
                            ${awayModeZones.includes(i) ? 'checked' : ''}
                            value="${i}">
                        Enable
                    </label>
                </td>
            `;
            
            // Add focus/blur event listeners to prevent refresh while interacting
            const homeCheckbox = row.querySelector(`#home-zone-${i}`);
            const awayCheckbox = row.querySelector(`#away-zone-${i}`);
            
            homeCheckbox.addEventListener('focus', () => {
                isModeInputFocused = true;
            });
            awayCheckbox.addEventListener('focus', () => {
                isModeInputFocused = true;
            });
            
            homeCheckbox.addEventListener('blur', () => {
                isModeInputFocused = false;
            });
            awayCheckbox.addEventListener('blur', () => {
                isModeInputFocused = false;
            });
            
            tableBody.appendChild(row);
        });
    }
    
    function renderSchedules(){
        const scheduleBody = document.getElementById('sched');
        scheduleBody.innerHTML = '';
    
        // Handle case where schedules might be undefined
        if (!schedules || !Array.isArray(schedules)) return;
        
        schedules.forEach(s => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${s.action === 'arm' ? 'Arm' : 'Disarm'}</td>
                <td>${s.time}</td>
                <td>${s.repeat ? 'Yes' : 'No'}</td>
                <td><button onclick="delSched(${s.id})">Delete</button></td>
            `;
            scheduleBody.appendChild(row);
        });
    }
    
    function fillPins(){
        const pinListBody = document.getElementById('plist');
        pinListBody.innerHTML = '';
    
        zoneLabels.forEach((label, i) => {
            const row = document.createElement('tr');
            // Use string index to get the pin
            const currentPin = pinLayout[i.toString()] || 0;
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>${label}</td>
                <td><input type="number" class="pin-input" id="pin-${i}" value="${currentPin}" min="0"></td>
            `;
            
            // Add focus/blur event listeners
            const input = row.querySelector('input');
            input.addEventListener('focus', () => {
                isPinInputFocused = true;
            });
            input.addEventListener('blur', () => {
                isPinInputFocused = false;
            });
            
            pinListBody.appendChild(row);
        });
    }
    
    async function toggleZone(i){
        await fetch('/api/zone_arm', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({index: i, armed: !zoneArmed[i]})
        });
        fetchAll();
    }
    
    gbtn.addEventListener('click', async () => {
        showLoading();
        try {
            await fetch('/api/arm', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({armed: !armed})
            });
            await fetchAll();
        } finally {
            hideLoading();
        }
    });
    
    async function saveLabels(){
        const newLabels = document.getElementById('lab').value.split('\n')
            .map(label => label.trim())
            .filter(label => label !== '');
        
        if (newLabels.length === 0) {
            alert('Please enter at least one label.');
            return;
        }
        
        showLoading();
        try {
            const response = await fetch('/api/set_labels', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({labels: newLabels})
            });
            
            if (!response.ok) {
                throw new Error('Labels saved!');
            }
            
            const result = await response.json();
            zoneLabels = newLabels;
            homeModeZones = result.home_mode_zones;
            awayModeZones = result.away_mode_zones;
            pinLayout = result.pin_layout;
            
            render();
            renderOptions();
            renderModes();
            renderSchedules();
            fillPins();
            
            alert('Zone labels saved successfully!');
        } catch (error) {
            console.error('Error saving labels:', error);
            alert('Labels saved!'); 
        } finally {
            hideLoading();
        }
    }
    
    async function saveDingZones(){
        const dingZones = [];
        document.querySelectorAll('#ding-zones-list input[type="checkbox"]').forEach(cb => {
            if (cb.checked) dingZones.push(parseInt(cb.value));
        });
    
        showLoading();
        try {
            await fetch('/api/set_ding_zones', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ding_zones: dingZones})
            });
            alert('Ding zones saved!');
            await fetchAll();
        } finally {
            hideLoading();
        }
    }
    
    async function setMode(newMode){
        showLoading();
        try {
            await fetch('/api/set_mode', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({mode: newMode})
            });
            await fetchAll();
        } finally {
            hideLoading();
        }
    }
    
    async function saveHomeAwayZones(){
        const homeZones = [];
        const awayZones = [];
        
        // Collect selections from the table
        for (let i = 0; i < zoneLabels.length; i++) {
            const homeCheckbox = document.getElementById(`home-zone-${i}`);
            const awayCheckbox = document.getElementById(`away-zone-${i}`);
            
            if (homeCheckbox && homeCheckbox.checked) {
                homeZones.push(i);
            }
            if (awayCheckbox && awayCheckbox.checked) {
                awayZones.push(i);
            }
        }
    
        showLoading();
        try {
            await fetch('/api/set_mode_zones', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({home: homeZones, away: awayZones})
            });
            alert('Mode configurations saved!');
            await fetchAll();
        } finally {
            hideLoading();
        }
    }
    
    async function addSched(){
        const action = document.getElementById('sact').value;
        const time = document.getElementById('stime').value;
        const repeat = document.getElementById('srep').checked;
    
        if (!time) {
            alert('Please enter a time for the schedule.');
            return;
        }
    
        showLoading();
        try {
            await fetch('/api/add_schedule', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: action,
                    time: time,
                    repeat: repeat
                })
            });
            await fetchAll();
        } finally {
            hideLoading();
        }
    }
    
    async function delSched(id){
        if (!confirm('Are you sure you want to delete this schedule?')) return;
    
        showLoading();
        try {
            await fetch('/api/delete_schedule', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id})
            });
            await fetchAll();
        } finally {
            hideLoading();
        }
    }
    
    async function savePinLayout(){
        // Create an object with string keys for zone indices
        const newPinLayout = {};
        
        for (let i = 0; i < zoneLabels.length; i++) {
            const input = document.getElementById(`pin-${i}`);
            if (input) {
                const pinValue = parseInt(input.value) || 0;
                if (pinValue < 0) {
                    alert(`Invalid pin value for zone ${i+1}. Must be a positive number.`);
                    return;
                }
                // Use string key (important for backend)
                newPinLayout[i.toString()] = pinValue;
            }
        }
    
        showLoading();
        try {
            const response = await fetch('/api/set_pin_layout', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(newPinLayout)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to save pin layout');
            }
            
            await fetchAll();
            alert('Pin layout saved successfully!');
        } catch (error) {
            console.error('Error saving pin layout:', error);
            alert(`Error: ${error.message}`);
        } finally {
            hideLoading();
        }
    }
    
    // User management functions
    async function loadUsers() {
        try {
            const response = await fetch('/api/users');
            if (!response.ok) throw new Error('Failed to load users');
            return await response.json();
        } catch (error) {
            console.error('Error loading users:', error);
            return {};
        }
    }
    
    async function renderUsers() {
        const users = await loadUsers();
        const table = document.getElementById('usersTable');
        table.innerHTML = '';
        
        for (const [id, user] of Object.entries(users)) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${id}</td>
                <td>${user.username}</td>
                <td>${user.is_admin ? 'Yes' : 'No'}</td>
                <td>
                    <button onclick="editUser('${id}', '${user.username}', ${user.is_admin})">Edit</button>
                    <button onclick="deleteUser('${id}')">Delete</button>
                </td>
            `;
            table.appendChild(row);
        }
    }
    
    function showCreateUserForm() {
        document.getElementById('userFormTitle').textContent = 'Create User';
        document.getElementById('userId').value = '';
        document.getElementById('editUsername').value = '';
        document.getElementById('editPassword').value = '';
        document.getElementById('editIsAdmin').checked = false;
        document.getElementById('userForm').style.display = 'block';
    }
    
    function editUser(id, username, isAdmin) {
        document.getElementById('userFormTitle').textContent = 'Edit User';
        document.getElementById('userId').value = id;
        document.getElementById('editUsername').value = username;
        document.getElementById('editPassword').value = '';
        document.getElementById('editIsAdmin').checked = isAdmin;
        document.getElementById('userForm').style.display = 'block';
    }
    
    function hideUserForm() {
        document.getElementById('userForm').style.display = 'none';
    }
    
    async function deleteUser(id) {
        if (!confirm(`Are you sure you want to delete user ${id}?`)) return;
        
        try {
            const response = await fetch(`/api/delete_user/${id}`, { method: 'POST' });
            if (response.ok) {
                renderUsers();
            } else {
                alert('Failed to delete user');
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Error deleting user');
        }
    }
    
    // Login functionality
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        try {
            const response = await fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
            });
            
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                const error = await response.text();
                document.getElementById('loginError').textContent = 'Invalid credentials';
            }
        } catch (error) {
            console.error('Login error:', error);
            document.getElementById('loginError').textContent = 'Login failed';
        }
    });
    
    // Logout functionality
    logoutBtn.addEventListener('click', async () => {
        await fetch('/logout');
        window.location.href = '/login';
    });
    
    // User form submission
    document.getElementById('userDataForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const userId = document.getElementById('userId').value;
        const username = document.getElementById('editUsername').value;
        const password = document.getElementById('editPassword').value;
        const isAdmin = document.getElementById('editIsAdmin').checked;
        
        try {
            let response;
            if (userId) {
                // Update existing user
                response = await fetch(`/api/update_user/${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username, 
                        password: password || null, 
                        is_admin: isAdmin 
                    })
                });
            } else {
                // Create new user
                response = await fetch('/api/create_user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username, 
                        password, 
                        is_admin: isAdmin 
                    })
                });
            }
            
            if (response.ok) {
                hideUserForm();
                renderUsers();
            } else {
                const error = await response.json();
                alert(error.error || 'Operation failed');
            }
        } catch (error) {
            console.error('Error saving user:', error);
            alert('Error saving user');
        }
    });

    // Initialize
    show('status');
    pollInterval = setInterval(fetchAll, 1000);
    fetchAll();
    
    // Global error handler
    window.addEventListener('error', (event) => {
        console.error('Critical Error:', event.message);
        alert('A critical error has occurred. Please Manually reboot the system.');
    });

    window.addEventListener('unhandledrejection', (event) => {
        console.error('Critical Error (Unhandled Promise Rejection):', event.reason);
        alert('A critical error has occurred. Please Manually reboot the system.');
    });
    
    </script>

</body>
</html>