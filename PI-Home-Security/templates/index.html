<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Alarm Dashboard</title>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; margin: 0; }
    header, nav { background: #333; color: #fff; padding: 1em; text-align: center; }
    nav button { background: none; border: none; color: #fff; padding: 0.8em; margin: 0 0.2em; cursor: pointer; }
    nav button.active { background: #555; }
    .content { padding: 1em; max-width: 800px; margin: auto; }
    .zones { display: flex; flex-wrap: wrap; gap: 1em; justify-content: center; }
    .zone { background: #fff; padding: 1em; border-radius: 5px; text-align: center; width: 140px; box-shadow: 0 0 5px #ccc; }
    .ok { border: 2px solid green; }
    .tripped { border: 2px solid red; }
    .disarmed { opacity: 0.5; }
    .arm-btn { padding: 0.5em; border: none; color: #fff; cursor: pointer; border-radius: 4px; }
    .arm-btn.save { background: green; }
    .arm-btn.disarm { background: red; }
    .pin-input { width: 60px; }
    .pin-save { background: teal; color: #fff; padding: 0.5em; border: none; border-radius: 4px; cursor: pointer; margin-top: 0.5em; }
    table { width: 100%; border: 1px solid #ccc; border-collapse: collapse; margin-top: 1em;}
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
    label { margin-left: 0.5em; }
    h3, h4 { margin-bottom: 0.5em; margin-top: 1.5em;}
    #pauseUpdates {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 1000;
      padding: 10px 15px;
      background: #555;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

<header><h1>Alarm Dashboard</h1></header>
<nav>
  <button onclick="show('status')" class="active">Status</button>
  <button onclick="show('options')">Options</button>
  <button onclick="show('modes')">Home/Away Mode</button>
  <button onclick="show('schedules')">Schedules</button>
  <button onclick="show('pinlayout')">Pin Layout</button>
</nav>

<div class="content">
  <div id="status">
    <button id="gbtn" class="arm-btn">Loading...</button>
    <div class="zones" id="zones"></div>
  </div>

  <div id="options" style="display:none;">
    <h3>Zone Labels:</h3>
    <textarea id="lab" rows="6" style="width:100%;"></textarea>
    <button onclick="saveLabels()">Save Labels</button>

    <h3>Ding on Unarmed Trip:</h3>
    <div id="ding-zones-list"></div>
    <button onclick="saveDingZones()">Save Ding Zones</button>
  </div>

  <div id="modes" style="display:none;">
    <h3>Select Current Mode:</h3>
    <label><input type="radio" name="mode" value="home" onchange="setMode('home')"> Home</label>
    <label><input type="radio" name="mode" value="away" onchange="setMode('away')"> Away</label>

    <h4>Armed Zones per Mode</h4>
    <div><strong>Home Mode Zones:</strong><div id="homezones-list"></div></div>
    <div><strong>Away Mode Zones:</strong><div id="awayzones-list"></div></div>
    <button onclick="saveHomeAwayZones()">Save</button>
  </div>

  <div id="schedules" style="display:none;">
    <h3>Current Schedules:</h3>
    <table><thead><tr><th>Zone</th><th>Action</th><th>Time</th><th>Repeat</th><th>Delete</th></tr></thead>
    <tbody id="sched"></tbody></table>

    <h3>Add New Schedule:</h3>
    <label for="szone">Zone:</label>
    <select id="szone"></select>
    <label for="sact">Action:</label>
    <select id="sact"><option value="arm">Arm</option><option value="disarm">Disarm</option></select>
    <label for="stime">Time:</label>
    <input type="time" id="stime"/>
    <label><input type="checkbox" id="srep"/> Repeat Daily</label>
    <button onclick="addSched()">Add Schedule</button>
  </div>

  <div id="pinlayout" style="display:none;">
    <h3>Zone to GPIO Pin Assignment:</h3>
    <table><thead><tr><th>Zone</th><th>GPIO</th></tr></thead>
    <tbody id="plist"></tbody></table>
    <button class="pin-save" onclick="savePinLayout()">Save Pin Layout</button>
  </div>
</div>

<audio id="alarmAudio" loop><source src="/static/alarm.mp3" type="audio/mpeg"/></audio>
<audio id="dingAudio"><source src="/static/ding.mp3" type="audio/mpeg"/></audio>

<button id="pauseUpdates" onclick="togglePause()">Pause Updates</button>

<script>
let armed, zones, zoneArmed, zoneLabels, pinLayout, schedules;
let mode, homeModeZones = [], awayModeZones = [], zoneDingUnarmed = [];
let isPaused = false;
const alarmAudio = document.getElementById('alarmAudio');
const dingAudio = document.getElementById('dingAudio');

function togglePause() {
  isPaused = !isPaused;
  document.getElementById("pauseUpdates").textContent = isPaused ? "Resume Updates" : "Pause Updates";
}

function fetchAll() {
  if (isPaused) return;

  fetch('/api/zone_status')
    .then(res => res.json())
    .then(js => {
      armed = js.armed;
      zones = js.zones;
      zoneArmed = js.zone_armed;
      zoneLabels = js.zone_labels;
      pinLayout = js.pin_layout;
      mode = js.mode;
      homeModeZones = js.home_mode_zones;
      awayModeZones = js.away_mode_zones;
      zoneDingUnarmed = js.zone_ding_unarmed;
      return fetch('/api/schedules');
    })
    .then(res => res.json())
    .then(js => {
      schedules = js;
      return Promise.all([
        fetch('/static/ding.flag').then(r => r.text()).catch(() => '0'),
        fetch('/static/alarm.flag').then(r => r.text()).catch(() => '0')
      ]);
    })
    .then(([ding, alarm]) => {
      if (ding.trim() === '1') {
        dingAudio.play().catch(() => {});
        fetch('/api/clear_ding');
      }
      if (alarm.trim() === '1') {
        alarmAudio.play().catch(() => {});
      } else {
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
        fetch('/api/clear_alarm');
      }

      if (!document.activeElement || document.activeElement.tagName !== "TEXTAREA") {
        render();
        renderOptions();
        renderModes();
        renderSchedules();
        fillPins();
      }
    });
}

function show(tab) {
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.querySelector(`nav button[onclick="show('${tab}')"]`)?.classList.add('active');

  ['status', 'options', 'modes', 'schedules', 'pinlayout'].forEach(id => {
    document.getElementById(id).style.display = id === tab ? 'block' : 'none';
  });
}

setInterval(fetchAll, 200);
fetchAll();
</script>
</body>
</html>
