<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Alarm Dashboard</title>
<style>
  body { font-family: sans-serif; background: #f4f4f4; margin: 0; }
  header, nav { background: #333; color: #fff; padding: 1em; text-align: center; }
  nav button { background: none; border: none; color: #fff; padding: 0.8em; margin: 0 0.2em; cursor: pointer; }
  nav button.active { background: #555; }
  .content { padding: 1em; max-width: 800px; margin: auto; }
  .zones { display: flex; flex-wrap: wrap; gap: 1em; justify-content: center; }
  .zone { background: #fff; padding: 1em; border-radius: 5px; text-align: center; width: 140px; box-shadow: 0 0 5px #ccc; }
  .ok { border: 2px solid green; }
  .tripped { border: 2px solid red; }
  .disarmed { opacity: 0.5; }
  .arm-btn { padding: 0.5em; border: none; color: #fff; cursor: pointer; border-radius: 4px; }
  .arm-btn.save { background: green; }
  .arm-btn.disarm { background: red; }
  .pin-input { width: 60px; }
  .pin-save { background: teal; color: #fff; padding: 0.5em; border: none; border-radius: 4px; cursor: pointer; margin-top: 0.5em; }
  table { width: 100%; border: 1px solid #ccc; border-collapse: collapse; margin-top: 1em;}
  th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
  label { margin-left: 0.5em; }
  h3, h4 { margin-bottom: 0.5em; margin-top: 1.5em;}
</style>
</head>
<body>

<header><h1>Alarm Dashboard</h1></header>
<nav>
  <button onclick="show('status')" class="active">Status</button>
  <button onclick="show('options')">Options</button>
  <button onclick="show('modes')">Home/Away Mode</button>
  <button onclick="show('phones')">Phone Numbers</button>
  <button onclick="show('schedules')">Schedules</button>
  <button onclick="show('pinlayout')">Pin Layout</button>
</nav>

<div class="content">
  <div id="status">
    <button id="gbtn" class="arm-btn">Loading...</button>
    <div class="zones" id="zones"></div>
  </div>

  <div id="options" style="display:none;">
    <h3>Zone Labels:</h3>
    <textarea id="lab" rows="6" style="width:100%;"></textarea>
    <button onclick="saveLabels()">Save Labels</button>

    <h3>Ding on Unarmed Trip:</h3>
    <p>Select zones that should play a "ding" sound when tripped, even if the system is unarmed.</p>
    <div id="ding-zones-list"></div>
    <button onclick="saveDingZones()">Save Ding Zones</button>
  </div>

  <div id="modes" style="display:none;">
    <h3>Select Current Mode:</h3>
    <label><input type="radio" name="mode" value="home" onchange="setMode('home')"> Home</label>
    <label><input type="radio" name="mode" value="away" onchange="setMode('away')"> Away</label>

    <h4>Armed Zones per Mode Configuration</h4>
    <p>Select which zones should be armed for detection when the system is in 'Home' or 'Away' mode.</p>
    <div>
        <strong>Home Mode Zones:</strong><br>
        <div id="homezones-list"></div>
    </div>
    <div>
        <strong>Away Mode Zones:</strong><br>
        <div id="awayzones-list"></div>
    </div>
    <button onclick="saveHomeAwayZones()">Save Mode Zone Configurations</button>
  </div>

  <div id="phones" style="display:none;">
    <h3>SMS Recipients (enter number@carrier-gateway):</h3>
    <p>Enter one email-to-SMS gateway address per line (e.g., 5551234567@vtext.com).</p>
    <textarea id="phone-numbers-text" rows="6" style="width:100%;"></textarea>
    <button onclick="savePhoneNumbers()">Save SMS List</button>
  </div>

  <div id="schedules" style="display:none;">
    <h3>Current Schedules:</h3>
    <table>
        <thead>
            <tr>
                <th>Zone (for context)</th>
                <th>Action</th>
                <th>Time</th>
                <th>Repeat Daily</th>
                <th>Delete</th>
            </tr>
        </thead>
      <tbody id="sched"></tbody>
    </table>
    <h3>Add New Schedule:</h3>
    <label for="szone">Zone:</label>
    <select id="szone"></select>
    <label for="sact">Action:</label>
    <select id="sact"><option value="arm">Arm</option><option value="disarm">Disarm</option></select>
    <label for="stime">Time:</label>
    <input type="time" id="stime"/>
    <label><input type="checkbox" id="srep"/> Repeat Daily</label>
    <button onclick="addSched()">Add Schedule</button>
  </div>

  <div id="pinlayout" style="display:none;">
    <h3>Zone to GPIO Pin Assignment:</h3>
    <p>Assign a Broadcom (BCM) GPIO pin number to each zone. Enter '0' or leave blank if a zone is unused.</p>
    <table>
        <thead>
            <tr>
                <th>Zone</th>
                <th>GPIO Pin Number</th>
            </tr>
        </thead>
        <tbody id="plist"></tbody>
    </table>
    <button class="pin-save" onclick="savePinLayout()">Save Pin Layout</button>
  </div>
</div>

<audio id="alarmAudio" loop><source src="/static/alarm.mp3" type="audio/mpeg"/></audio>
<audio id="dingAudio"><source src="/static/ding.mp3" type="audio/mpeg"/></audio>

<script>
let armed, zones, zoneArmed, zoneLabels, pinLayout, schedules;
let mode, homeModeZones = [], awayModeZones = [], smsNumbers = [], zoneDingUnarmed = [];
const alarmAudio = document.getElementById('alarmAudio');
const dingAudio = document.getElementById('dingAudio');

async function fetchAll() {
  try {
    const js = await (await fetch('/api/zone_status')).json();
    armed = js.armed;
    zones = js.zones;
    zoneArmed = js.zone_armed;
    zoneLabels = js.zone_labels;
    pinLayout = js.pin_layout;
    mode = js.mode;
    homeModeZones = js.home_mode_zones;
    awayModeZones = js.away_mode_zones;
    smsNumbers = js.sms_numbers;
    zoneDingUnarmed = js.zone_ding_unarmed;

    schedules = await (await fetch('/api/schedules')).json();

    // handle ding.flag
    const flagResponse = await fetch('/static/ding.flag');
    const flagText = await flagResponse.text();
    const flag = flagText.trim() === '1';

    if (flag) {
      dingAudio.play().catch(e => console.error("Error playing ding audio:", e));
      // Clear flag so sound only plays once until the next ding event
      await fetch('/api/clear_ding');
    }

    render();
    renderOptions(); // Handles labels and ding zones
    renderModes();
    renderPhones(); // This function will now prevent overwriting
    renderSchedules();
    fillPins();
  } catch (e) {
    console.error("Error fetching data:", e);
    // Optionally display an error message to the user
  }
}

function show(id){
  // Update active button styling
  document.querySelectorAll('nav button').forEach(button => {
    button.classList.remove('active');
  });
  const activeButton = document.querySelector(`nav button[onclick="show('${id}')"]`);
  if (activeButton) {
    activeButton.classList.add('active');
  }

  // Show/hide content sections
  ['status','options','modes','phones','schedules','pinlayout']
    .forEach(tab => document.getElementById(tab).style.display = (tab === id ? 'block' : 'none'));
}

function render(){
  // Update global arm/disarm button
  document.getElementById('gbtn').textContent = armed ? 'Disarm All' : 'Arm All';
  document.getElementById('gbtn').className = armed ? 'arm-btn disarm' : 'arm-btn save';

  // Render zones
  const zonesEl = document.getElementById('zones');
  zonesEl.innerHTML = '';
  zones.forEach((tripped, i) => {
    const div = document.createElement('div');
    const isArmedForDetection = zoneArmed[i];
    div.className = 'zone ' + (isArmedForDetection ? (tripped ? 'tripped' : 'ok') : 'disarmed');
    div.innerHTML = `<b>${zoneLabels[i]}</b><br>${tripped ? '❌ Tripped' : '✔️ OK'}<br>`;
    const btn = document.createElement('button');
    btn.textContent = isArmedForDetection ? 'Disarm Zone' : 'Arm Zone';
    btn.className = isArmedForDetection ? 'arm-btn disarm' : 'arm-btn save';
    btn.onclick = () => toggleZone(i);
    div.appendChild(btn);
    zonesEl.appendChild(div);
  });

  // Control alarm audio based on armed state and tripped zones
  const anyArmedZoneTripped = zones.some((tripped, i) => zoneArmed[i] && tripped);
  if (armed && anyArmedZoneTripped) {
    alarmAudio.play().catch(e => console.error("Error playing alarm audio:", e));
  } else {
    alarmAudio.pause();
    alarmAudio.currentTime = 0; // Reset audio to start for next time
  }
}

function renderOptions(){
  // Zone Labels
  const labelTextarea = document.getElementById('lab');
  // Only update textarea value if it's not currently being edited
  if (document.activeElement !== labelTextarea) {
    labelTextarea.value = zoneLabels.join('\n');
  }

  // Ding on Unarmed Trip zones
  const dingListEl = document.getElementById('ding-zones-list');
  dingListEl.innerHTML = '';
  zoneLabels.forEach((label, i) => {
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `ding-zone-${i}`;
    checkbox.value = i;
    checkbox.checked = zoneDingUnarmed.includes(i);
    checkbox.onchange = () => {
      // Update the local zoneDingUnarmed array when checkbox changes
      if (checkbox.checked) {
        if (!zoneDingUnarmed.includes(i)) zoneDingUnarmed.push(i);
      } else {
        zoneDingUnarmed = zoneDingUnarmed.filter(zoneIdx => zoneIdx !== i);
      }
      // Keep array sorted for consistency, though not strictly necessary for functionality
      zoneDingUnarmed.sort((a,b) => a-b);
    };
    const labelEl = document.createElement('label');
    labelEl.htmlFor = `ding-zone-${i}`;
    labelEl.textContent = label;
    dingListEl.appendChild(checkbox);
    dingListEl.appendChild(labelEl);
    dingListEl.appendChild(document.createElement('br'));
  });
}

function renderModes(){
  // Set current mode radio button
  const modeRadio = document.querySelector(`input[name=mode][value=${mode}]`);
  if (modeRadio) {
    modeRadio.checked = true;
  }

  // Render home mode zones checkboxes
  const homeZonesListEl = document.getElementById('homezones-list');
  homeZonesListEl.innerHTML = '';
  zoneLabels.forEach((label, i) => {
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `home-zone-${i}`;
    checkbox.value = i;
    checkbox.checked = homeModeZones.includes(i);
    checkbox.onchange = () => {
      if (checkbox.checked) {
        if (!homeModeZones.includes(i)) homeModeZones.push(i);
      } else {
        homeModeZones = homeModeZones.filter(zoneIdx => zoneIdx !== i);
      }
      homeModeZones.sort((a,b) => a-b);
    };
    const labelEl = document.createElement('label');
    labelEl.htmlFor = `home-zone-${i}`;
    labelEl.textContent = label;
    homeZonesListEl.appendChild(checkbox);
    homeZonesListEl.appendChild(labelEl);
    homeZonesListEl.appendChild(document.createElement('br'));
  });

  // Render away mode zones checkboxes
  const awayZonesListEl = document.getElementById('awayzones-list');
  awayZonesListEl.innerHTML = '';
  zoneLabels.forEach((label, i) => {
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `away-zone-${i}`;
    checkbox.value = i;
    checkbox.checked = awayModeZones.includes(i);
    checkbox.onchange = () => {
      if (checkbox.checked) {
        if (!awayModeZones.includes(i)) awayModeZones.push(i);
      } else {
        awayModeZones = awayModeZones.filter(zoneIdx => zoneIdx !== i);
      }
      awayModeZones.sort((a,b) => a-b);
    };
    const labelEl = document.createElement('label');
    labelEl.htmlFor = `away-zone-${i}`;
    labelEl.textContent = label;
    awayZonesListEl.appendChild(checkbox);
    awayZonesListEl.appendChild(labelEl);
    awayZonesListEl.appendChild(document.createElement('br'));
  });
}

function renderPhones(){
  const phoneNumberTextarea = document.getElementById('phone-numbers-text');
  // Only update textarea value if it's not currently being edited
  if (document.activeElement !== phoneNumberTextarea) {
    phoneNumberTextarea.value = smsNumbers.join('\n');
  }
}

function renderSchedules(){
  const szoneSelect = document.getElementById('szone');
  szoneSelect.innerHTML = ''; // Clear previous options
  // Add an option for "Global" or "N/A" if the schedule doesn't relate to a specific zone
  szoneSelect.add(new Option("N/A (Global)", -1)); // Use -1 or null as a special value

  zoneLabels.forEach((label, i) => szoneSelect.add(new Option(label, i)));


  const scheduleBody = document.getElementById('sched');
  scheduleBody.innerHTML = '';
  schedules.forEach(s => {
    const tr = scheduleBody.insertRow();
    // Get zone label, default to "N/A (Global)" if index is out of bounds or -1
    const zoneDisplay = (s.zone !== undefined && s.zone >= 0 && s.zone < zoneLabels.length) ? zoneLabels[s.zone] : "N/A (Global)";
    tr.innerHTML = `
      <td>${zoneDisplay}</td>
      <td>${s.action}</td>
      <td>${s.time}</td>
      <td>${s.repeat ? 'Yes' : 'No'}</td>
      <td><button onclick="delSched(${s.id})">Delete</button></td>
    `;
  });
}

function fillPins(){
  const pinListBody = document.getElementById('plist');
  pinListBody.innerHTML = ''; // Clear existing rows

  // Ensure zoneLabels is available to determine the number of rows
  if (!zoneLabels || zoneLabels.length === 0) {
      console.warn("No zones defined to fill pin layout.");
      return;
  }

  // Create rows for each zone, even if no pin is currently assigned in pinLayout
  for (let i = 0; i < zoneLabels.length; i++) {
    const row = pinListBody.insertRow();
    const zoneLabel = zoneLabels[i];
    // Use pinLayout value if it exists, otherwise default to 0
    const currentPin = pinLayout[i] !== undefined ? pinLayout[i] : 0;

    row.innerHTML = `
      <td>${zoneLabel}</td>
      <td><input class="pin-input" id="pin-${i}" type="number" value="${currentPin}" min="0" /></td>
    `;
  }
}

async function toggleZone(i){
  await fetch('/api/zone_arm', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({index: i, armed: !zoneArmed[i]})
  });
  fetchAll(); // Re-fetch all data to update UI
}

document.getElementById('gbtn').onclick = async () => {
  await fetch('/api/arm', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({armed: !armed})
  });
  fetchAll(); // Re-fetch all data to update UI
};

async function saveLabels(){
  const newLabels = document.getElementById('lab').value.split('\n').filter(x => x.trim() !== ''); // Filter out empty lines
  if (newLabels.length === 0) {
      alert('Please enter at least one label.');
      return;
  }
  await fetch('/api/set_labels', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({labels: newLabels})
  });
  alert('Zone labels saved!');
  fetchAll(); // Re-fetch all data to update UI
}

async function saveDingZones(){
  // zoneDingUnarmed is already updated by the checkboxes in renderOptions
  await fetch('/api/set_ding_zones', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ding_zones: zoneDingUnarmed})
  });
  alert('Ding zones saved!');
  fetchAll(); // Re-fetch all data to update UI
}

async function setMode(newMode){
  await fetch('/api/set_mode', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({mode: newMode})
  });
  fetchAll(); // Re-fetch all data to update UI
}

async function saveHomeAwayZones(){
  // homeModeZones and awayModeZones are already updated by the checkboxes in renderModes
  await fetch('/api/set_mode_zones', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({home: homeModeZones, away: awayModeZones})
  });
  alert('Home/Away mode zone configurations saved!');
  fetchAll(); // Re-fetch all data to update UI
}

async function savePhoneNumbers(){
  const nums = document.getElementById('phone-numbers-text').value.split('\n').filter(x => x.trim() !== ''); // Filter out empty lines
  await fetch('/api/set_sms', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({sms: nums})
  });
  alert('SMS recipient list saved!');
  fetchAll(); // Re-fetch all data to update UI
}

async function addSched(){
  const zoneIndex = parseInt(document.getElementById('szone').value, 10);
  const action = document.getElementById('sact').value;
  const time = document.getElementById('stime').value;
  const repeat = document.getElementById('srep').checked;

  if (!time) {
    alert('Please enter a time (HH:MM) for the schedule.');
    return;
  }
  if (isNaN(zoneIndex)) { // Basic check for valid zone index
      alert('Invalid zone selected for schedule context.');
      return;
  }


  await fetch('/api/add_schedule', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      zone: zoneIndex >= 0 ? zoneIndex : null, // Send null if "N/A (Global)" is selected
      action: action,
      time: time,
      repeat: repeat
    })
  });
  fetchAll(); // Re-fetch all data to update UI
}

async function delSched(id){
  if (!confirm('Are you sure you want to delete this schedule?')) {
    return;
  }
  await fetch('/api/delete_schedule', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({id: id})
  });
  fetchAll(); // Re-fetch all data to update UI
}

async function savePinLayout(){
  const newPinLayout = {};
  const pinInputs = document.querySelectorAll('#plist input.pin-input');
  let hasError = false;
  pinInputs.forEach(input => {
    const zoneIdx = input.id.replace('pin-', '');
    const pinVal = parseInt(input.value, 10);
    if (isNaN(pinVal) || pinVal < 0) { // Basic validation for non-negative integers
        alert(`Invalid pin number entered for ${zoneLabels[zoneIdx] || `Zone ${parseInt(zoneIdx)+1}`}. Please enter a non-negative number.`);
        hasError = true;
        return; // Exit forEach early
    }
    newPinLayout[zoneIdx] = pinVal;
  });

  if (hasError) return; // Stop if there was a validation error

  await fetch('/api/set_pin_layout', { // Corrected endpoint name
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(newPinLayout)
  });
  alert('Pin layout saved!');
  fetchAll(); // Re-fetch all data to update UI
}


setInterval(fetchAll, 2000); // Poll every 2 seconds for updates
fetchAll(); // Initial fetch on page load
</script>

</body>
</html>